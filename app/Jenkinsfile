pipeline {
     agent any
     environment {
         DOCKER_IMAGE = "my-flask-app"  // Dynamic image name using build tag or branch
           DOCKER_BUILDKIT = '1' 
     }
 
     stages {
         stage('Clone Repository') {
             steps {
 
                git branch: 'main', url:'https://github.com/ShrutiBhapkar/Devops-projects.git'
             }
         }
 
 
         stage('login Docker Hub') {
             steps {
                 withCredentials([usernamePassword(credentialsId: 'docker-hub-credens', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                      bat """
                       echo Logging into Docker Hub...
                        docker logout
                        docker login --username %DOCKER_USERNAME% --password %DOCKER_PASSWORD%
                        if %ERRORLEVEL% NEQ 0 (
                            echo Docker login failed!
                            exit /b 1
                        ) else (
                            echo Docker login successful!
                        )
                        set DOCKER_BUILDKIT=1
                 
                    docker build -t %DOCKER_IMAGE% -f app/Dockerfile app
                   
                  docker tag %DOCKER_IMAGE% %DOCKER_USERNAME%/%DOCKER_IMAGE%:latest
                   
                    docker push %DOCKER_USERNAME%/%DOCKER_IMAGE%:latest
                     """
                 }
             }
         }


         stage('Deploy to Kubernetes') {
             steps {
                script {
    // Base Docker image name (without the tag)
    env.DOCKER_IMAGE = "my-flask-app"

    // Get the system name using uname (this will give you "Linux", "Darwin", etc.)
    def unameValue = "shru940"

    // Define the tag as 'latest'
                     
    def tag = "latest"  // You want this to always be 'latest'

    // Combine uname (system name), base image, and the 'latest' tag into the full Docker image tag
    def fullImage = "${unameValue}:${env.DOCKER_IMAGE}:${tag}"  // Example: "Linux:my-flask-app:latest"

    // Debugging: Verify the full Docker image path
    echo "Full Docker Image: ${fullImage}"  // Should print something like "Linux:my-flask-app:latest"
    
    // Read the YAML file and replace the placeholder with the full image tag
    def updatedYaml = readFile('app/K8s/deployment.yaml')
                          .replace('{{IMAGE_NAME}}', fullImage)
    
    // Debugging: Print the updated YAML to verify the change
    echo "Updated YAML:\n${updatedYaml}"
    
    // Write the updated YAML to a temporary file
    writeFile file: 'app/K8s/deployment-temp.yaml', text: updatedYaml
    
    // Apply the updated YAML file to Kubernetes
    bat 'kubectl apply -f app\\K8s\\deployment-temp.yaml'
    
    // Optionally delete the temporary file after applying
    bat 'del app\\K8s\\deployment-temp.yaml'
}

             }
         }
     }
 }
